name: Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: alphabet-linux
          - os: windows-latest
            artifact_name: alphabet-windows.exe
          - os: macos-latest
            artifact_name: alphabet-macos

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }}

    - name: Test
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: build/alphabet*
        if-no-files-found: error

  build-asan:
    runs-on: ubuntu-latest
    name: Build with AddressSanitizer

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure CMake with AddressSanitizer
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_ASAN=ON -DBUILD_TESTS=ON

    - name: Build with AddressSanitizer
      run: cmake --build build --config Debug

    - name: Run tests with AddressSanitizer
      working-directory: build
      run: ctest -C Debug --output-on-failure
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1

  golden-tests:
    runs-on: ubuntu-latest
    name: Golden File Tests

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Run golden file tests
      working-directory: build
      run: |
        for test_file in ../tests/golden_files/*.abc; do
          test_name=$(basename "$test_file" .abc)
          expected_file="../tests/golden_files/${test_name}.expected"
          if [ -f "$expected_file" ]; then
            echo "Running golden test: $test_name"
            ./alphabet "$test_file" > "${test_name}.actual" 2>&1 || true
            if diff -q "$expected_file" "${test_name}.actual" > /dev/null; then
              echo "  PASSED"
            else
              echo "  FAILED"
              echo "Expected:"
              cat "$expected_file"
              echo "Actual:"
              cat "${test_name}.actual"
              exit 1
            fi
          else
            echo "  WARNING: No expected file for $test_name"
          fi
        done

  package:
    runs-on: ubuntu-latest
    name: Create Distribution Packages
    needs: [build]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Create packages with CPack
      run: cmake --build build --target package

    - name: Upload DEB package
      uses: actions/upload-artifact@v4
      with:
        name: alphabet-deb-package
        path: build/*.deb
        if-no-files-found: ignore

    - name: Upload TAR.GZ package
      uses: actions/upload-artifact@v4
      with:
        name: alphabet-targz-package
        path: build/*.tar.gz
        if-no-files-found: ignore

  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install clang-format
      run: sudo apt-get install -y clang-format

    - name: Check code formatting
      run: |
        echo "Checking code formatting..."
        find src/include -name "*.h" -o -name "*.cpp" | xargs clang-format --dry-run || true
        find src -name "*.cpp" | xargs clang-format --dry-run || true
        echo "Format check complete"

    - name: Check for common issues
      run: |
        echo "Checking for TODO/FIXME comments..."
        grep -r "TODO\|FIXME" src/include/ src/ || echo "No TODO/FIXME found"
